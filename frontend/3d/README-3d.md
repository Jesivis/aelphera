# Aelphera 3D Terrain Preview

This directory contains a prototype 3D terrain visualization for Aelphera using Three.js.

## Overview

The 3D terrain preview demonstrates:
- **Heightmap-based terrain generation** from GeoJSON data
- **Multi-material blending** (sand, grass, rock, lava, ice) based on elevation and slope
- **Stylized shaders** with smooth transitions between terrain types
- **Interactive camera controls** for exploring the terrain

## Quick Start

### 1. Generate the Heightmap

First, you need to generate the heightmap from GeoJSON data:

```bash
cd /home/runner/work/aelphera/aelphera
npm run generate:heightmap
```

This script reads `data/neighborhoods.geojson` and `data/lots.geojson` and creates a 512x512 grayscale PNG heightmap at `frontend/3d/assets/heightmap.png`.

### 2. Preview the 3D Terrain

Open `frontend/3d/index.html` in a web browser. For best results, serve it via a local web server:

```bash
# Using Python 3
cd frontend/3d
python3 -m http.server 8080

# Or using Node.js
npx http-server -p 8080

# Or using PHP
php -S localhost:8080
```

Then navigate to `http://localhost:8080` in your browser.

### 3. Controls

- **Left Mouse Button**: Rotate camera
- **Right Mouse Button**: Pan camera
- **Mouse Wheel**: Zoom in/out

## Required Assets

### Textures

The following texture files should be placed in `frontend/3d/assets/`:

- `terrain-sand.png` - Sand texture (16x16+ pixels, seamless)
- `terrain-grass.png` - Grass texture
- `terrain-rock.png` - Rock/stone texture
- `terrain-lava.png` - Lava/volcanic texture
- `terrain-ice.png` - Ice/snow texture
- `heightmap.png` - Generated heightmap (created by script)

**Note**: Placeholder 16x16 solid color textures are included. Replace them with high-quality seamless textures for better visuals.

### Heightmap

The heightmap is generated by the `scripts/generate-heightmap.js` script, which:
1. Reads GeoJSON features from `data/neighborhoods.geojson` and `data/lots.geojson`
2. Projects geographic coordinates to a 512x512 pixel grid
3. Assigns elevation based on:
   - Neighborhood category (residential, commercial, volcanic, arctic, etc.)
   - Lot elevation values
   - Procedural Perlin noise for natural variation
   - Special terrain types (lava, ice) from `properties.terrain`
4. Outputs a grayscale PNG where brightness = elevation (0-255)

## Architecture

### Files

- `index.html` - Minimal HTML page that loads Three.js and the app
- `app-3d.js` - Main Three.js application (scene setup, asset loading, rendering)
- `shaders/terrain.vs` - Vertex shader (heightmap displacement)
- `shaders/terrain.fs` - Fragment shader (5-material blending)
- `assets/` - Textures and generated heightmap

### Shader System

The terrain uses a custom shader material that:

1. **Vertex Shader** (`terrain.vs`):
   - Samples the heightmap texture
   - Displaces vertex Y position based on height value
   - Calculates normals from heightmap gradients for lighting

2. **Fragment Shader** (`terrain.fs`):
   - Blends 5 material textures based on elevation thresholds:
     - **Sand**: 0.0 - 0.15 (low elevation)
     - **Grass**: 0.15 - 0.35 (low-medium)
     - **Rock**: 0.35 - 0.55 (medium, also on steep slopes)
     - **Lava**: 0.55 - 0.75 (high)
     - **Ice**: 0.75 - 1.0 (highest)
   - Uses `smoothstep` for painterly, soft transitions
   - Adds rock material on steep slopes
   - Applies directional lighting
   - Adds glow effect for lava

### Customization

You can adjust terrain blending by modifying the uniforms in `app-3d.js`:

```javascript
uniforms.sandLevel.value = 0.15;   // Adjust thresholds
uniforms.grassLevel.value = 0.35;
uniforms.rockLevel.value = 0.55;
uniforms.lavaLevel.value = 0.75;
uniforms.iceLevel.value = 0.90;
uniforms.blendSharpness.value = 0.1; // Transition smoothness
uniforms.heightScale.value = 30.0;   // Vertical exaggeration
```

## GeoJSON Format

The heightmap generator expects GeoJSON features with the following properties:

**Neighborhoods** (`data/neighborhoods.geojson`):
```json
{
  "properties": {
    "name": "District Name",
    "category": "residential|commercial|mountains|volcanic|arctic|beach",
    "elevation": 20,
    "terrain": "lava|ice|sand|rock" // Optional, overrides category
  }
}
```

**Lots** (`data/lots.geojson`):
```json
{
  "properties": {
    "name": "Lot Name",
    "lotId": "lot-001",
    "elevation": 5
  }
}
```

## Future Enhancements

- Add dynamic texture atlas support
- Implement water plane for oceans/lakes
- Add fog and atmospheric effects
- Include collision detection for gameplay
- Support animated lava flows
- Add procedural vegetation placement
- Export terrain mesh for game engine import

## Troubleshooting

**Textures not loading**: Ensure you're serving the files via HTTP (not `file://`). Browsers block local file access for security.

**Heightmap is blank**: Run `npm run generate:heightmap` to create the heightmap from GeoJSON data.

**Performance issues**: Reduce the plane geometry resolution in `app-3d.js` (currently 255x255 segments).

## Credits

- Three.js: https://threejs.org/
- Aelphera Project: https://github.com/Jesivis/aelphera
